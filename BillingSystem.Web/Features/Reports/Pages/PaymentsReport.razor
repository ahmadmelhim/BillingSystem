@page "/reports/payments"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using BillingSystem.Core.DTOs
@using BillingSystem.Core.Interfaces
@using MudBlazor

@inject IReportService ReportService
@inject ISnackbar Snackbar
@inject LanguageService Lang
@implements IDisposable

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4">@Lang["PaymentsReport"]</MudText>

    <!-- Filters -->
    <MudGrid Class="mb-4" GutterSize="3">
        <MudItem xs="12" sm="4">
            <MudTextField T="string"
                          Label="@Lang["Search"]"
                          @bind-Value="_searchText"
                          Immediate="true" />
        </MudItem>

        <MudItem xs="12" sm="3">
            <MudDatePicker T="DateTime?"
                           Label="@Lang["From"]"
                           @bind-Date="_fromDate"
                           DateFormat="dd/MM/yyyy" />
        </MudItem>

        <MudItem xs="12" sm="3">
            <MudDatePicker T="DateTime?"
                           Label="@Lang["To"]"
                           @bind-Date="_toDate"
                           DateFormat="dd/MM/yyyy" />
        </MudItem>

        <MudItem xs="12" sm="2" Class="d-flex align-center">
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="ReloadAsync">
                @Lang["Filter"]
            </MudButton>
            <MudButton Color="Color.Secondary"
                       Variant="Variant.Outlined"
                       Class="ml-2"
                       OnClick="ClearFilters">
                @Lang["Cancel"]
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    else
    {
        <!-- Summary Cards -->
        <MudGrid Class="mb-4" GutterSize="3">
            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-3">
                    <MudText Typo="Typo.subtitle2">@Lang["TotalPayments"]</MudText>
                    <MudText Typo="Typo.h6">@_rows.Count</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-3">
                    <MudText Typo="Typo.subtitle2">@Lang["TotalAmount"]</MudText>
                    <MudText Typo="Typo.h6">₪@_totalAmount.ToString("N2")</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-3">
                    <MudText Typo="Typo.subtitle2">@Lang["AveragePayment"]</MudText>
                    <MudText Typo="Typo.h6">
                        @(_rows.Count == 0 ? "0.00" : "₪" + (_totalAmount / _rows.Count).ToString("N2"))
                    </MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Data Table -->
        <MudTable Items="_rows" Dense="true" Hover="true" Bordered="true">
            <HeaderContent>
                <MudTh>@Lang["PaymentDate"]</MudTh>
                <MudTh>@Lang["Customer"]</MudTh>
                <MudTh>@Lang["InvoiceNumber"]</MudTh>
                <MudTh>@Lang["PaymentMethod"]</MudTh>
                <MudTh>@Lang["Amount"]</MudTh>
                <MudTh>@Lang["Notes"]</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="@Lang["PaymentDate"]">
                    @context.Date.ToString("dd/MM/yyyy")
                </MudTd>
                <MudTd DataLabel="@Lang["Customer"]">
                    @context.CustomerName
                </MudTd>
                <MudTd DataLabel="@Lang["InvoiceNumber"]">
                    @context.InvoiceNumber
                </MudTd>
                <MudTd DataLabel="@Lang["PaymentMethod"]">
                    @context.Method
                </MudTd>
                <MudTd DataLabel="@Lang["Amount"]">
                    ₪@context.Amount.ToString("N2")
                </MudTd>
                <MudTd DataLabel="@Lang["Notes"]">
                    @context.Note
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>

@code {
    private bool _isLoading = true;
    private string? _errorMessage;

    private string? _searchText;
    private DateTime? _fromDate;
    private DateTime? _toDate;

    private IReadOnlyList<PaymentReportDto> _rows = new List<PaymentReportDto>();
    private decimal _totalAmount;

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            _rows = await ReportService.GetPaymentsAsync(_searchText, _fromDate, _toDate);
            _totalAmount = _rows.Sum(r => r.Amount);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ClearFilters()
    {
        _searchText = null;
        _fromDate = null;
        _toDate = null;
        _ = ReloadAsync();
    }

    protected override void OnInitialized()
    {
        Lang.OnLanguageChanged += StateHasChanged;
    }

    public void Dispose()
    {
        Lang.OnLanguageChanged -= StateHasChanged;
    }
}

