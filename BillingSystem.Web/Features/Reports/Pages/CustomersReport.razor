@page "/reports/customers"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using BillingSystem.Core.DTOs
@using BillingSystem.Core.Interfaces
@using MudBlazor

@inject IReportService ReportService
@inject ISnackbar Snackbar
@inject LanguageService Lang
@implements IDisposable

<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4">@Lang["CustomersReport"]</MudText>

    <!-- Filters -->
    <MudGrid Class="mb-4" GutterSize="3">
        <MudItem xs="12" sm="4">
            <MudTextField T="string"
                          Label="@Lang["Search"]"
                          @bind-Value="_searchText"
                          Immediate="true" />
        </MudItem>

        <MudItem xs="12" sm="3">
            <MudDatePicker T="DateTime?"
                           Label="@Lang["From"]"
                           @bind-Date="_fromDate"
                           DateFormat="dd/MM/yyyy" />
        </MudItem>

        <MudItem xs="12" sm="3">
            <MudDatePicker T="DateTime?"
                           Label="@Lang["To"]"
                           @bind-Date="_toDate"
                           DateFormat="dd/MM/yyyy" />
        </MudItem>

        <MudItem xs="12" sm="2" Class="d-flex align-center">
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="ReloadAsync">
                @Lang["Filter"]
            </MudButton>
            <MudButton Color="Color.Secondary"
                       Variant="Variant.Outlined"
                       Class="ml-2"
                       OnClick="ClearFilters">
                @Lang["Cancel"]
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    else
    {
        <!-- Summary Cards -->
        <MudGrid Class="mb-4" GutterSize="3">
            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-3">
                    <MudText Typo="Typo.subtitle2">@Lang["TotalCustomers"]</MudText>
                    <MudText Typo="Typo.h6">@_rows.Count</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-3">
                    <MudText Typo="Typo.subtitle2">@Lang["TotalInvoicesValue"]</MudText>
                    <MudText Typo="Typo.h6">₪@_totalInvoices.ToString("N2")</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-3">
                    <MudText Typo="Typo.subtitle2">@Lang["TotalPaymentsReceived"]</MudText>
                    <MudText Typo="Typo.h6">₪@_totalPayments.ToString("N2")</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Data Table -->
        <MudTable Items="_rows" Dense="true" Hover="true" Bordered="true">
            <HeaderContent>
                <MudTh>@Lang["Customer"]</MudTh>
                <MudTh>@Lang["Email"]</MudTh>
                <MudTh>@Lang["Phone"]</MudTh>
                <MudTh align="right">@Lang["Invoices"]</MudTh>
                <MudTh align="right">@Lang["TotalInvoices"]</MudTh>
                <MudTh align="right">@Lang["TotalPayments"]</MudTh>
                <MudTh align="right">@Lang["RemainingBalance"]</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="@Lang["Customer"]">@context.CustomerName</MudTd>
                <MudTd DataLabel="@Lang["Email"]">@context.Email</MudTd>
                <MudTd DataLabel="@Lang["Phone"]">@context.Phone</MudTd>
                <MudTd DataLabel="@Lang["Invoices"]" Align="Align.Right">@context.InvoiceCount</MudTd>
                <MudTd DataLabel="@Lang["TotalInvoices"]" Align="Align.Right">₪@context.TotalInvoiced.ToString("N2")</MudTd>
                <MudTd DataLabel="@Lang["TotalPayments"]" Align="Align.Right">₪@context.TotalPaid.ToString("N2")</MudTd>
                <MudTd DataLabel="@Lang["RemainingBalance"]" Align="Align.Right">
                    ₪@context.Outstanding.ToString("N2")
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>

@code {
    private bool _isLoading = true;
    private string? _errorMessage;

    private string? _searchText;
    private DateTime? _fromDate;
    private DateTime? _toDate;

    private IReadOnlyList<CustomerReportDto> _rows = new List<CustomerReportDto>();

    private decimal _totalInvoices;
    private decimal _totalPayments;

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            _rows = await ReportService.GetCustomerSummaryAsync(_searchText, _fromDate, _toDate);
            _totalInvoices = _rows.Sum(r => r.TotalInvoiced);
            _totalPayments = _rows.Sum(r => r.TotalPaid);
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ClearFilters()
    {
        _searchText = null;
        _fromDate = null;
        _toDate = null;
        _ = ReloadAsync();
    }

    protected override void OnInitialized()
    {
        Lang.OnLanguageChanged += StateHasChanged;
    }

    public void Dispose()
    {
        Lang.OnLanguageChanged -= StateHasChanged;
    }
}
