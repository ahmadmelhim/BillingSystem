@page "/login"
@layout BillingSystem.Web.Shared.Layouts.PublicLayout


@using System.ComponentModel.DataAnnotations
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject LanguageService Lang
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Elevation="4" Class="pa-8" Style="border-radius: 16px;">
        <MudStack Spacing="4" AlignItems="AlignItems.Center" Class="mb-6">
            <MudAvatar Color="Color.Primary" Size="Size.Large" Style="width: 80px; height: 80px;">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" />
            </MudAvatar>
            <MudText Typo="Typo.h4" Align="Align.Center" Style="font-weight: 600;">@Lang["WelcomeBack"]</MudText>
            <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">@Lang["SignInToContinue"]</MudText>
        </MudStack>
        <MudForm @ref="_form" Model="@_model">
            <MudStack Spacing="3">
                <MudTextField T="string" @bind-Value="_model.Email" Label="@Lang["EmailAddress"]" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Email" Required="true" RequiredError="@Lang["EmailAddress"]" Validation="@(new EmailAddressAttribute())" />
                <MudTextField T="string" @bind-Value="_model.Password" Label="@Lang["Password"]" Variant="Variant.Outlined" InputType="@_passwordInputType" Adornment="Adornment.End" AdornmentIcon="@_passwordIcon" OnAdornmentClick="TogglePasswordVisibility" AdornmentAriaLabel="Show Password" Required="true" RequiredError="@Lang["Password"]" />
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true" Class="mt-2">@_errorMessage</MudAlert>
                }
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" FullWidth="true" OnClick="HandleLogin" Disabled="_isLoading" Class="mt-4" Style="height: 50px; border-radius: 8px; font-size: 16px; font-weight: 600;">
                    @if (_isLoading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>@Lang["SigningIn"]</span>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Login" Class="mr-2" />
                        <span>@Lang["SignIn"]</span>
                    }
                </MudButton>
                <MudDivider Class="my-4" />
                <MudStack Row="true" Justify="Justify.Center" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.body2">@Lang["DontHaveAccount"]</MudText>
                    <MudLink Href="/register" Typo="Typo.body2" Color="Color.Primary" Style="font-weight: 600;">@Lang["SignUp"]</MudLink>
                </MudStack>
            </MudStack>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private MudForm? _form;
    private LoginModel _model = new();
    private bool _isLoading = false;
    private string? _errorMessage;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordIcon = Icons.Material.Filled.VisibilityOff;

    protected override void OnInitialized()
    {
        Lang.OnLanguageChanged += StateHasChanged;
    }

    public void Dispose()
    {
        Lang.OnLanguageChanged -= StateHasChanged;
    }

    private void TogglePasswordVisibility()
    {
        if (_passwordInputType == InputType.Password)
        {
            _passwordInputType = InputType.Text;
            _passwordIcon = Icons.Material.Filled.Visibility;
        }
        else
        {
            _passwordInputType = InputType.Password;
            _passwordIcon = Icons.Material.Filled.VisibilityOff;
        }
    }

    private async Task HandleLogin()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_form.IsValid) return;
        }
        _isLoading = true;
        _errorMessage = null;
        try
        {
            var request = new LoginRequest 
            { 
                Email = _model.Email, 
                Password = _model.Password 
            };
            
            var result = await AuthService.LoginAsync(request);
            if (result != null)
            {
                Snackbar.Add(Lang["Success"], Severity.Success);
                
                // Redirect based on role
                if (result.Role == "Admin")
                {
                    Navigation.NavigateTo("/admin/dashboard", true);
                }
                else
                {
                    Navigation.NavigateTo("/dashboard", true);
                }
            }
            else
            {
                _errorMessage = Lang["InvalidCredentials"];
            }
        }
        catch
        {
            _errorMessage = Lang["Error"];
        }
        finally
        {
            _isLoading = false;
        }
    }

    private class LoginModel
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}


