@page "/dashboard"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using BillingSystem.Core.DTOs
@using BillingSystem.Core.Interfaces
@using MudBlazor

@inject IReportService ReportService
@inject ISnackbar Snackbar
@inject LanguageService Lang
@implements IDisposable

<MudPaper Class="pa-4">

    <MudText Typo="Typo.h5" Class="mb-4">@Lang["Dashboard"]</MudText>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
    }
    else
    {
        <!-- Main Invoice Cards -->
        <MudGrid GutterSize="3" Class="mb-4">
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Class="d-flex flex-column align-center justify-center pa-4 h-100">
                    <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
                    <MudText Typo="Typo.subtitle1" Align="Align.Center">@Lang["TotalInvoices"]</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Primary">@_data.TotalInvoices</MudText>
                    <MudText Typo="Typo.caption">₪ @_data.TotalAmount.ToString("N2")</MudText>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Class="d-flex flex-column align-center justify-center pa-4 h-100">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Success" Class="mb-2" />
                    <MudText Typo="Typo.subtitle1" Align="Align.Center">@Lang["Paid"]</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Success">@_data.PaidInvoices</MudText>
                    <MudText Typo="Typo.caption">₪ @_data.PaidAmount.ToString("N2")</MudText>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Class="d-flex flex-column align-center justify-center pa-4 h-100">
                    <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Size="Size.Large" Color="Color.Warning" Class="mb-2" />
                    <MudText Typo="Typo.subtitle1" Align="Align.Center">@Lang["Pending"]</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Warning">@_data.PendingInvoices</MudText>
                    <MudText Typo="Typo.caption">₪ @_data.PendingAmount.ToString("N2")</MudText>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Class="d-flex flex-column align-center justify-center pa-4 h-100">
                    <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" Class="mb-2" />
                    <MudText Typo="Typo.subtitle1" Align="Align.Center">@Lang["Overdue"]</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Error">@_data.OverdueInvoices</MudText>
                    <MudText Typo="Typo.caption">₪ @_data.OverdueAmount.ToString("N2")</MudText>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Additional Stats Cards -->
        <MudGrid GutterSize="3" Class="mb-4">
            <MudItem xs="12" sm="4">
                <MudCard Elevation="2" Class="pa-3 d-flex flex-row align-center gap-3">
                    <MudAvatar Color="Color.Info" Icon="@Icons.Material.Filled.People" />
                    <div>
                        <MudText Typo="Typo.subtitle2">@Lang["TotalCustomers"]</MudText>
                        <MudText Typo="Typo.h6">@_data.TotalCustomers</MudText>
                    </div>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudCard Elevation="2" Class="pa-3 d-flex flex-row align-center gap-3">
                    <MudAvatar Color="Color.Secondary" Icon="@Icons.Material.Filled.Payment" />
                    <div>
                        <MudText Typo="Typo.subtitle2">@Lang["PaymentCount"]</MudText>
                        <MudText Typo="Typo.h6">@_data.TotalPayments</MudText>
                    </div>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudCard Elevation="2" Class="pa-3 d-flex flex-row align-center gap-3">
                    <MudAvatar Color="Color.Success" Icon="@Icons.Material.Filled.AttachMoney" />
                    <div>
                        <MudText Typo="Typo.subtitle2">@Lang["TotalPayments"]</MudText>
                        <MudText Typo="Typo.h6">₪ @_data.TotalPaymentsAmount.ToString("N2")</MudText>
                    </div>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Charts -->
        <MudText Typo="Typo.h6" Class="mt-6 mb-4" Style="font-weight: 600;">@Lang["AnalyticsAndStatistics"]</MudText>
        
        <MudGrid Spacing="3">
            <!-- Donut: Invoice Status Distribution -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="3" Style="border-radius: 12px; height: 100%;">
                    <MudText Typo="Typo.h6" Class="mb-4" Style="color: #1976d2; font-weight: 500;">
                        @Lang["InvoiceStatusDistribution"]
                    </MudText>
                    <MudDivider Class="mb-4" />
                    <MudChart ChartType="ChartType.Donut"
                              Width="100%" Height="320px"
                              InputData="@_statusData"
                              InputLabels="@_statusLabels"
                              ChartOptions="@_pieChartOptions">
                        <CustomGraphics>
                            <text class="mud-charts-legend" x="50%" y="44%" dominant-baseline="middle" text-anchor="middle" fill="#757575" font-size="12" font-weight="500">@Lang["Total"]</text>
                            <text class="mud-charts-legend" x="50%" y="56%" dominant-baseline="middle" text-anchor="middle" fill="#212121" font-size="28" font-weight="700">@_data.TotalInvoices</text>
                        </CustomGraphics>
                    </MudChart>
                </MudPaper>
            </MudItem>

            <!-- Bar: Payments by Month -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Elevation="3" Style="border-radius: 12px; height: 100%;">
                    <MudText Typo="Typo.h6" Class="mb-4" Style="color: #1976d2; font-weight: 500;">
                        @Lang["PaymentsByMonth"]
                    </MudText>
                    <MudDivider Class="mb-4" />
                    <MudChart ChartType="ChartType.Bar"
                              Width="100%" Height="320px"
                              ChartSeries="@_paymentsSeries"
                              XAxisLabels="@_paymentsLabels"
                              ChartOptions="@_paymentsBarChartOptions" />
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Top 5 Customers -->
        <MudPaper Class="mt-4 pa-4" Elevation="3" Style="border-radius: 12px;">
            <MudText Typo="Typo.h6" Class="mb-4" Style="color: #1976d2; font-weight: 500;">
                @Lang["Top5Customers"]
            </MudText>
            <MudDivider Class="mb-4" />
            <MudChart ChartType="ChartType.Bar"
                      Width="100%" Height="320px"
                      ChartSeries="@_topCustomersSeries"
                      XAxisLabels="@_topCustomersLabels"
                      ChartOptions="@_customersBarChartOptions" />
        </MudPaper>
    }
</MudPaper>

@code {
    private bool _isLoading = true;
    private string? _errorMessage;

    private DashboardDto _data = new();

    // Chart Data
    private string[] _statusLabels = Array.Empty<string>();
    private double[] _statusData = Array.Empty<double>();
    
    private ChartOptions _pieChartOptions = new()
    {
        ChartPalette = new[] 
        { 
            "#2E7D32",  // Green for Paid
            "#F57C00",  // Orange for Pending
            "#C62828"   // Red for Overdue
        }
    };
    
    private ChartOptions _paymentsBarChartOptions = new()
    {
        ChartPalette = new[] { "#0D47A1" },
        YAxisLines = true,
        InterpolationOption = InterpolationOption.Straight,
        MaxNumYAxisTicks = 8
    };
    
    private ChartOptions _customersBarChartOptions = new()
    {
        ChartPalette = new[] { "#00695C" },
        YAxisLines = true,
        InterpolationOption = InterpolationOption.Straight,
        MaxNumYAxisTicks = 8
    };

    private string[] _paymentsLabels = Array.Empty<string>();
    private List<ChartSeries> _paymentsSeries = new();

    private string[] _topCustomersLabels = Array.Empty<string>();
    private List<ChartSeries> _topCustomersSeries = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardAsync();
    }

    private async Task LoadDashboardAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            _data = await ReportService.GetDashboardSummaryAsync();

            // Prepare Charts
            _statusLabels = _data.InvoiceStatusDistribution.Select(x => x.Label).ToArray();
            _statusData = _data.InvoiceStatusDistribution.Select(x => x.Value).ToArray();

            _paymentsLabels = _data.PaymentsByMonth.Select(x => x.Label).ToArray();
            _paymentsSeries = new List<ChartSeries>
            {
                new ChartSeries { Name = Lang["Payments"], Data = _data.PaymentsByMonth.Select(x => x.Value).ToArray() }
            };

            _topCustomersLabels = _data.TopCustomers.Select(x => x.Label).ToArray();
            _topCustomersSeries = new List<ChartSeries>
            {
                new ChartSeries { Name = Lang["TotalInvoices"], Data = _data.TopCustomers.Select(x => x.Value).ToArray() }
            };
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        Lang.OnLanguageChanged += StateHasChanged;
    }

    public void Dispose()
    {
        Lang.OnLanguageChanged -= StateHasChanged;
    }
}
